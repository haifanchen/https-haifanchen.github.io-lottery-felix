<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å¸¦åº“å­˜çš„è®¢å•å·æŠ½å¥–</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;margin:0;background:#f7f7f7;}
  .wrap{max-width:600px;margin:60px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
  h1,h2{text-align:center;color:#333;}
  input,button{padding:10px 14px;font-size:16px;border-radius:4px;border:1px solid #ccc;}
  button{background:#007aff;color:#fff;border:none;cursor:pointer;margin-left:8px;}
  button:disabled{background:#aaa;cursor:not-allowed;}
  #result{margin-top:20px;font-size:20px;font-weight:bold;text-align:center;}
  table{width:100%;border-collapse:collapse;margin-top:20px;}
  th,td{padding:6px 10px;border-bottom:1px solid #eee;text-align:left;font-size:14px;}
  .admin{display:none;}
  .tab{display:flex;border-bottom:1px solid #ccc;margin-bottom:15px;}
  .tab div{cursor:pointer;padding:8px 20px;}
  .tab .active{border-bottom:2px solid #007aff;font-weight:bold;}
</style>
</head>
<body>

<div class="wrap">
  <div class="tab">
    <div class="active" onclick="switchTab('draw')">æŠ½å¥–</div>
    <div onclick="switchTab('admin')">åå°</div>
  </div>

  <!-- ===== æŠ½å¥–é¢æ¿ ===== -->
  <div id="drawPanel">
    <h1>ğŸ è®¢å•å·æŠ½å¥–</h1>
    <input id="orderInput" placeholder="è¯·è¾“å…¥ä»»æ„è®¢å•å·" maxlength="30"/>
    <button onclick="draw()">ç«‹å³æŠ½å¥–</button>
    <div id="result"></div>
  </div>

  <!-- ===== åå°é¢æ¿ ===== -->
  <div id="adminPanel" class="admin">
    <h2>åå°æ•°æ®</h2>
    <button onclick="exportCSV()">å¯¼å‡º CSV</button>
    <table id="adminTable">
      <thead><tr><th>è®¢å•å·</th><th>ç¤¼å“</th><th>æ—¶é—´</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
/* ========= IndexedDB å°è£… ========= */
const DB_NAME = 'lotteryDB';
const STORE_RECORDS = 'records';
const STORE_STOCK = 'stock';
let db;

/* ===== æš—å·è§£é”åå° ===== */
const ADMIN_HASH = '#admin2025';          // æƒ³æ¢æš—å·æ”¹è¿™é‡Œ
function unlockAdmin(){
  localStorage.setItem('__admin', '1');
  switchTab('admin');
}
function checkUnlock(){
  if(location.hash === ADMIN_HASH){
    unlockAdmin();
    history.replaceState(null, '', location.pathname); // æ¸…æ‰ # é¿å…æ³„éœ²
  }
  if(localStorage.getItem('__admin') === '1'){
    // å·²è§£é”è¿‡ï¼Œç›´æ¥æ˜¾ç¤ºåå°æŒ‰é’®
    document.querySelector('.tab').style.display='flex';
  }else{
    // æœªè§£é”ï¼Œéšè—åå° Tab
    document.querySelector('.tab').style.display='none';
  }
}
checkUnlock();
window.addEventListener('hashchange', checkUnlock);

// åˆå§‹åŒ–æ•°æ®åº“
function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onerror = ()=>reject(req.error);
    req.onsuccess = ()=>{ db = req.result; resolve(); };
    req.onupgradeneeded = (e)=>{
      const d = e.target.result;
      if(!d.objectStoreNames.contains(STORE_RECORDS)){
        d.createObjectStore(STORE_RECORDS, {keyPath:'order', unique:true});
      }
      if(!d.objectStoreNames.contains(STORE_STOCK)){
        d.createObjectStore(STORE_STOCK, {keyPath:'gift'});
      }
    };
  });
}

// å†™å…¥ä¸€æ¡è®°å½•
async function addRecord(order, gift){
  const tx = db.transaction(STORE_RECORDS, 'readwrite');
  tx.objectStore(STORE_RECORDS).put({order, gift, ts:Date.now()});
  return tx.complete;
}

// è¯»å–æ‰€æœ‰è®°å½•
async function getAllRecords(){
  return new Promise(res=>{
    const tx = db.transaction(STORE_RECORDS, 'readonly');
    const req = tx.objectStore(STORE_RECORDS).getAll();
    req.onsuccess = ()=>res(req.result);
  });
}

// åº“å­˜è¯»å†™
async function initStock(stocks){
  const tx = db.transaction(STORE_STOCK, 'readwrite');
  const store = tx.objectStore(STORE_STOCK);
  for(const [gift,qty] of Object.entries(stocks)){
    const exist = await new Promise(r=>{
      const q = store.get(gift);
      q.onsuccess = ()=>r(q.result);
    });
    if(!exist) store.put({gift, qty});
  }
  return tx.complete;
}

async function getStock(){
  const all = await new Promise(res=>{
    const tx = db.transaction(STORE_STOCK, 'readonly');
    const req = tx.objectStore(STORE_STOCK).getAll();
    req.onsuccess = ()=>res(req.result);
  });
  return Object.fromEntries(all.map(x=>[x.gift, x.qty]));
}

async function decreaseStock(gift){
  const tx = db.transaction(STORE_STOCK, 'readwrite');
  const store = tx.objectStore(STORE_STOCK);
  const req = store.get(gift);
  req.onsuccess = ()=>{
    const item = req.result;
    if(item && item.qty>0){
      item.qty -= 1;
      store.put(item);
    }
  };
  return tx.complete;
}

/* ========= ä¸šåŠ¡é€»è¾‘ ========= */
const initialStock = {
  "iPhone 15": 1,
  "Switch": 2,
  "AirPods": 3,
  "100å…ƒä»£é‡‘åˆ¸": 5,
  "50å…ƒä»£é‡‘åˆ¸": 10,
  "è°¢è°¢å‚ä¸": 9999   // æ°¸ä¸ç¼ºè´§
};

// ä¼ªéšæœº
function pseudoIndex(seed, len){
  let h=0;
  for(let i=0;i<seed.length;i++) h=((h<<5)-h+seed.charCodeAt(i))&0xffffffff;
  return Math.abs(h)%len;
}

// åˆå§‹åŒ–
await openDB();
await initStock(initialStock);

// å…¨å±€å‡½æ•°ä¾› HTML è°ƒç”¨
window.draw = async function(){
  const order = document.getElementById('orderInput').value.trim();
  if(!order){ alert('è¯·è¾“å…¥è®¢å•å·'); return; }

  // å·²æŠ½è¿‡ç›´æ¥è¿”å›
  const records = await getAllRecords();
  const hit = records.find(r=>r.order===order);
  if(hit){
    document.getElementById('result').innerText = `è¯¥è®¢å•å·²æŠ½ä¸­ï¼š${hit.gift}`;
    return;
  }

  // è®¡ç®—å¯ç”¨ç¤¼å“
  const stock = await getStock();
  const available = Object.entries(stock).filter(([,q])=>q>0);
  if(available.length===0){
    document.getElementById('result').innerText = 'æ‰€æœ‰ç¤¼å“å·²å‘å®Œï¼';
    return;
  }

  const giftIdx = pseudoIndex(order, available.length);
  const [gift] = available[giftIdx];

  // æ‰£åº“å­˜ & å†™è®°å½•
  await decreaseStock(gift);
  await addRecord(order, gift);

  document.getElementById('result').innerText = `è®¢å•å·ï¼š${order}\næ­å–œè·å¾—ï¼š${gift}ï¼`;
};

// åå°å±•ç¤º
window.switchTab = function(tab){
  document.querySelectorAll('.tab div').forEach(d=>d.classList.remove('active'));
  document.querySelector(`.tab div[onclick*="${tab}"]`).classList.add('active');
  if(tab==='admin'){
    document.getElementById('drawPanel').style.display='none';
    document.getElementById('adminPanel').style.display='block';
    refreshAdmin();
  }else{
    document.getElementById('drawPanel').style.display='block';
    document.getElementById('adminPanel').style.display='none';
  }
};

async function refreshAdmin(){
  const rows = await getAllRecords();
  const tbody = document.querySelector('#adminTable tbody');
  tbody.innerHTML='';
  rows.sort((a,b)=>b.ts-a.ts).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.order}</td><td>${r.gift}</td><td>${new Date(r.ts).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });
}

window.exportCSV = async function(){
  const rows = await getAllRecords();
  const csv = 'è®¢å•å·,ç¤¼å“,æ—¶é—´\n' + 
        rows.map(r=>`"${r.order}","${r.gift}",${new Date(r.ts).toISOString()}`).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='lottery_records.csv'; a.click();
  URL.revokeObjectURL(url);
};
</script>

</body>
</html>


